package commands

import (
	"EverythingSuckz/fsb/config"
	"EverythingSuckz/fsb/internal/utils"
	"github.com/celestix/gotgproto/dispatcher"
	"github.com/celestix/gotgproto/dispatcher/handlers"
	"github.com/celestix/gotgproto/ext"
	"github.com/celestix/gotgproto/storage"
	"github.com/celestix/gotgproto/tg"
)

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
func checkSubscription(ctx *ext.Context, chatId int64, channelId string) bool {
	member, err := ctx.BotAPI.GetChatMember(channelId, chatId)
	if err != nil {
		// ÙÙŠ Ø­Ø§Ù„ Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚
		return false
	}

	// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø¹Ø¶Ùˆ "Ù…Ø´Ø§Ø±Ùƒ" Ø£Ùˆ "Ø£Ø¹Ø¶Ø§Ø¡")
	if member.Status == "member" || member.Status == "administrator" || member.Status == "creator" {
		return true
	}
	return false
}

func (m *command) LoadStart(dispatcher dispatcher.Dispatcher) {
	log := m.log.Named("start")
	defer log.Sugar().Info("Loaded")
	dispatcher.AddHandler(handlers.NewCommand("start", start))
}

func start(ctx *ext.Context, u *ext.Update) error {
	chatId := u.EffectiveChat().GetID()
	peerChatId := ctx.PeerStorage.GetPeerById(chatId)
	if peerChatId.Type != int(storage.TypeUser) {
		return dispatcher.EndGroups
	}

	// Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© ØºÙŠØ± ÙØ§Ø±ØºØ©ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
	if len(config.ValueOf.AllowedUsers) != 0 && !utils.Contains(config.ValueOf.AllowedUsers, chatId) {
		ctx.Reply(u, "You are not allowed to use this bot.", nil)
		return dispatcher.EndGroups
	}

	// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©
	channelId := "@zezzez" // Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠÙ‡Ø§
	if !checkSubscription(ctx, chatId, channelId) {
		ctx.Reply(u, "Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ù‚Ù†Ø§ØªÙ†Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª. Ø§Ù„Ù‚Ù†Ø§Ø©: @zezzez", nil)
		return dispatcher.EndGroups
	}

	// Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ© ÙˆØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
	ctx.Reply(u, `Ù‡Ù„Ø§ ÙˆØ³Ù‡Ù„Ø§ØŒ 
Ø§ØªØ¨Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø£Ø¯Ù†Ø§Ù‡ Ù„ÙƒÙŠ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¨ÙˆØª Ø¹Ù†Ø¯Ùƒ Ø¨ØµÙˆØ±Ø© Ù…Ø³ØªÙ…Ø±Ø©:

âœ…|- Ø§Ø´ØªØ±Ùƒ Ø¨Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙˆØª (Ø´Ø¨ÙƒØ© Ø§ÙˆÙƒØ³Ø¬ÙŠÙ†) ğŸ‘‡ğŸ»
@zezzez

Ø«Ù… Ù‚Ù… Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ù…Ù‚Ø·Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø¥Ø±Ø³Ø§Ù„Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª Ø­ØªÙ‰ ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙˆØ±Ø§Ø¨Ø· Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ØµÙˆØ±Ø© Ø³Ø±ÙŠØ¹Ø©âš¡ï¸.`, nil)

	return dispatcher.EndGroups
}
